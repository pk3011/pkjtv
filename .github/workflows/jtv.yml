name: Auto Update JioTV Cookie

permissions:
  contents: write

on:
  schedule:
    - cron: "32 16 * * *"
  workflow_dispatch:

jobs:
  update-cookie:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch cookie from API (GitHub Secret)
        run: |
          set -e

          FULL_COOKIE=$(curl -fsSL "${{ secrets.COOKIE_API_URL }}" | jq -r '.[0].cookie')

          if [ -z "$FULL_COOKIE" ] || [ "$FULL_COOKIE" = "null" ]; then
            echo "‚ùå Cookie fetch failed"
            exit 1
          fi

          # Remove "__hdnea__=" prefix for URL usage
          COOKIE_VALUE="${FULL_COOKIE#__hdnea__=}"

          echo "FULL_COOKIE=$FULL_COOKIE" >> $GITHUB_ENV
          echo "COOKIE_VALUE=$COOKIE_VALUE" >> $GITHUB_ENV

      - name: Update cookie in jtv.m3u
        run: |
          set -e

          if [ ! -f "jtv.m3u" ]; then
            echo "‚ùå jtv.m3u not found"
            exit 1
          fi

          echo "üîÅ Updating EXTHTTP cookies..."
          sed -i 's#"cookie":"__hdnea__=[^"]*"#"cookie":"'"$FULL_COOKIE"'"#g' jtv.m3u

          echo "üîÅ Updating MPD URL hdnea token..."
          sed -i 's#__hdnea__=[^&"]*#__hdnea__='"$COOKIE_VALUE"'#g' jtv.m3u

      - name: Commit & Push changes
        run: |
          set -e

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git diff --quiet; then
            echo "‚ÑπÔ∏è No changes detected"
            exit 0
          fi

          git add jtv.m3u
          git commit -m "Auto update JioTV cookie"
          git push
